<!DOCTYPE html><html lang="ja"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width"><link rel="icon" href="data:">
<title>ふくいdeお得クーポン決済マップ - ふくいのデジタル</title>
</head><body>
<h1>ふくいdeお得クーポン決済マップ</h1>

<select id=selcate></select>
<div id=divmap></div>
メッシュ毎の使用された金額（万円、全期間）<br>
※店舗にカテゴリーが最大2つ設定されているので、各カテゴリー合計と総合計金額は一致しません

<script type="module">
import { deck } from "https://code4fukui.github.io/deck-es/deck.js";
import { createGSILayer } from "https://code4fukui.github.io/deck-es/examples/createGSILayer.js";
import { CSV } from "https://js.sabae.cc/CSV.js";
import { Geo3x3 } from "https://geo3x3.com/Geo3x3.js";
import { ArrayUtil } from "https://js.sabae.cc/ArrayUtil.js";
//import { InputCheckbox } from "https://code4fukui.github.io/input-checkbox/input-checkbox.js";
//import { InputRadio } from "https://code4fukui.github.io/input-radio/input-radio.js";
import { addComma } from "https://js.sabae.cc/Num.js";

const trs = await CSV.fetchJSON("./mesh-tr-total.csv");

const cate = ArrayUtil.toUnique(trs.map(s => s.カテゴリー).filter(s => s));
/*
const chks = {};
for (const c of cate) {
  const chk = new InputCheckbox(c);
  divcate.appendChild(chk);
  chk.checked = true;
  chks[c] = chk;
}
*/
for (const c of cate) {
  const opt = document.createElement("option");
  opt.textContent = c;
  selcate.appendChild(opt);
}

const baseLayer = createGSILayer();

const zoomth = 8;
let textLayer = null;

const deckgl = new deck.DeckGL({
  container: "divmap",
  initialViewState: {
    longitude: 136.22,
    latitude: 36.06,
    zoom: 9,
  },
  controller: true,
  layers: [baseLayer],
  onViewStateChange: ({viewState}) => {
    console.log(viewState);
    console.log(deckgl.layers);
    if (textLayer) {
      console.log(textLayer);
      //textLayer.setProps({ visible: viewState.zoom >= zoomth });
      //textLayer.props.visible = viewState.zoom >= zoomth;
    }
    /*
      const scatterplotLayer = deckgl.layers.find(layer => layer.id === 'textlayer');
        scatterplotLayer.setProps({ visible: viewState.zoom >= 8 });
    }
    */
  },
});

const show = () => {
  // 店舗コード,利用回数,利用金額,ユニーク利用者数,利用金額平均,利用金額最高,利用金額差

  const dataar = [];
  for (const tr of trs) {
    if (selcate.value != tr.カテゴリー) {
      continue;
    }

    const geo = tr.Geo3x3;
    const pos = Geo3x3.decode(geo);
    const d = {
      p: [pos.lng, pos.lat],
      v: tr.利用金額,
    };
    dataar.push(d);
  }

  const scatterplotLayer = new deck.ScatterplotLayer({
    data: dataar,
    opacity: 0.8,
    getPosition: d => d.p,
    getRadius: d => Math.sqrt(d.v) * .1,
    //getFillColor: d => [Math.sqrt(d.v) / 10, 30, 30],
    getFillColor: d => [255, 30, 30],
  });
  textLayer = new deck.TextLayer({
    id: "textlayer",
    data: dataar,
    stroked: true,
    filled: false,
    getPosition: d => d.p,
    background: false,
    //backgroundPadding: [8, 8, 8, 8],
    //getBackgroundColor: [217, 234, 236],
    //テキスト設定
    getText: d => "" + Math.floor(d.v / 10000),
    getColor: [255, 255, 255],
    getAngle: 0,
    fontWeight: "bold",
    sizeScale: 0.4,
    //visible: deckgl.viewState.zoom >= zoomth,
    sizeUnits: "meters",
    getSize: 300,
    //sizeMinPixels: 30,
    //sizeMaxPixels: 30,
    //characterSet: charaSet, //生成したキャラクターセットをdeck.glに渡す
  });

  deckgl.setProps({
    layers: [baseLayer, scatterplotLayer, textLayer],
  });
};

show();

/*
for (const chk of Object.values(chks)) {
  chk.onchange = () => show();
}
*/
selcate.onchange = () => show();

</script>

<style>
#divmap {
  height: 70vh;
}
</style>

<hr>
DATA: ふくいdeお得クーポン取扱店一覧 - <a href=https://www.fukui-digital.co.jp/>株式会社ふくいのデジタル</a><br>
MAP: <a href=https://maps.gsi.go.jp/>地理院地図</a><br>
<a href=https://github.com/code4fukui/fukui-kanko-coupon>src on GitHub</a>
</body></html>
